<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - OneZeroEight.ai</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f9fafb;
            --text: #374151;
            --text-light: #6b7280;
            --border: #e5e7eb;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--light);
            color: var(--text);
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            color: white;
            padding: 24px;
            text-align: center;
        }
        .header h1 { font-size: 1.75rem; margin-bottom: 4px; }
        .header p { opacity: 0.9; }
        .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card .value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .stat-card .label { font-size: 0.9rem; color: var(--text-light); margin-top: 4px; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
        }
        .tab {
            padding: 10px 20px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }
        .tab:hover { background: var(--light); }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
            overflow: hidden;
        }
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h2 { font-size: 1.1rem; font-weight: 600; }
        .card-body { padding: 20px; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        th { font-weight: 600; color: var(--text-light); font-size: 0.85rem; text-transform: uppercase; }
        tr:hover { background: var(--light); }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-primary { background: #e0e7ff; color: #4338ca; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        
        /* Playlist badges with colors */
        .playlist-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .playlist-electronic { background: #ede9fe; color: #6d28d9; }
        .playlist-lofi { background: #d1fae5; color: #047857; }
        .playlist-hiphop { background: #fee2e2; color: #dc2626; }
        .playlist-pop { background: #fce7f3; color: #be185d; }
        .playlist-rnb { background: #ede9fe; color: #7c3aed; }
        .playlist-ambient { background: #dbeafe; color: #1d4ed8; }
        .playlist-rock { background: #fef3c7; color: #b45309; }
        .playlist-indie { background: #ffedd5; color: #c2410c; }
        .playlist-jazz { background: #f3f4f6; color: #374151; }
        .playlist-classical { background: #fef9c3; color: #854d0e; }
        .playlist-latin { background: #fed7aa; color: #c2410c; }
        .playlist-world { background: #ccfbf1; color: #0f766e; }
        .playlist-country { background: #fef3c7; color: #92400e; }
        .playlist-gospel { background: #e0e7ff; color: #4338ca; }
        .playlist-discoveries { background: #f0fdf4; color: #15803d; }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--secondary); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
        
        /* Action buttons in table */
        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .action-btn {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            border: 1px solid var(--border);
            background: white;
            transition: all 0.2s;
        }
        .action-btn:hover { background: var(--light); }
        .action-btn.placed { background: #d1fae5; border-color: #10b981; color: #065f46; }
        .action-btn.delete { border-color: #ef4444; color: #ef4444; }
        .action-btn.delete:hover { background: #fee2e2; }
        .action-btn.agent { border-color: #8b5cf6; color: #8b5cf6; }
        .action-btn.agent:hover { background: #ede9fe; }
        
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { font-size: 1.25rem; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }
        .modal-body { padding: 20px; }
        
        /* Form elements */
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; }
        .form-group select, .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
        }
        .form-group textarea { min-height: 80px; resize: vertical; }
        
        /* Track preview */
        .track-preview {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--light);
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .track-info h4 { font-weight: 600; margin-bottom: 4px; }
        .track-info p { color: var(--text-light); font-size: 0.9rem; margin-bottom: 8px; }
        
        /* Agent output */
        .agent-output {
            background: #1f2937;
            color: #e5e7eb;
            padding: 16px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 12px;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--dark);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 2000;
            display: none;
        }
        .toast.success { background: var(--secondary); }
        .toast.error { background: var(--danger); }
        .toast.show { display: block; }
        
        /* Empty/Loading states */
        .empty-state { text-align: center; padding: 48px; color: var(--text-light); }
        .loading { text-align: center; padding: 24px; color: var(--text-light); }
        
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .tabs { flex-wrap: wrap; }
            table { font-size: 0.85rem; }
            th, td { padding: 8px; }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>üéõÔ∏è OneZeroEight Admin</h1>
    <p>Submissions, Artists & Campaign Management</p>
</div>

<div class="container">
    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="value" id="statArtists">-</div>
            <div class="label">Artists</div>
        </div>
        <div class="stat-card">
            <div class="value" id="statSubmissions">-</div>
            <div class="label">Submissions</div>
        </div>
        <div class="stat-card">
            <div class="value" id="statPlacements">-</div>
            <div class="label">Placements</div>
        </div>
        <div class="stat-card">
            <div class="value" id="statCurators">-</div>
            <div class="label">Curators</div>
        </div>
        <div class="stat-card">
            <div class="value" id="statPlaylists">15</div>
            <div class="label">Playlists</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="showPanel('submissions')">üì• Submissions</button>
        <button class="tab" onclick="showPanel('artists')">üé§ Artists</button>
        <button class="tab" onclick="showPanel('curators')">üìã Curators</button>
        <button class="tab" onclick="showPanel('playlists')">üéµ Playlists</button>
    </div>

    <!-- Submissions Panel -->
    <div class="panel active" id="panel-submissions">
        <div class="card">
            <div class="card-header">
                <h2>Recent Submissions</h2>
                <button class="btn btn-primary btn-sm" onclick="loadSubmissions()">‚Üª Refresh</button>
            </div>
            <div class="card-body">
                <table>
                    <thead>
                        <tr>
                            <th>Track</th>
                            <th>Artist</th>
                            <th>Genre</th>
                            <th>Playlist</th>
                            <th>Tier</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="submissionsTable">
                        <tr><td colspan="7" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Artists Panel -->
    <div class="panel" id="panel-artists">
        <div class="card">
            <div class="card-header">
                <h2>All Artists</h2>
                <button class="btn btn-primary btn-sm" onclick="loadArtists()">‚Üª Refresh</button>
            </div>
            <div class="card-body">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Artist Name</th>
                            <th>Genre</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="artistsTable">
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Curators Panel -->
    <div class="panel" id="panel-curators">
        <div class="card">
            <div class="card-header">
                <h2>Curator Network</h2>
                <span id="curatorCount" style="color: var(--text-light); margin-left: 12px;"></span>
                <button class="btn btn-primary btn-sm" onclick="loadCurators()">‚Üª Refresh</button>
            </div>
            <div class="card-body">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Followers</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="curatorsTable">
                        <tr><td colspan="4" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Playlists Panel -->
    <div class="panel" id="panel-playlists">
        <div class="card">
            <div class="card-header">
                <h2>OneZeroEight Playlists</h2>
            </div>
            <div class="card-body">
                <table>
                    <thead>
                        <tr>
                            <th>Playlist</th>
                            <th>Genres</th>
                            <th>Spotify ID</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="playlistsTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Submission Modal -->
<div class="modal-overlay" id="submissionModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Submission Details</h3>
            <button class="modal-close" onclick="closeModal('submissionModal')">&times;</button>
        </div>
        <div class="modal-body" id="submissionModalContent"></div>
    </div>
</div>

<!-- Artist Edit Modal -->
<div class="modal-overlay" id="artistModal">
    <div class="modal">
        <div class="modal-header">
            <h3>Edit Artist</h3>
            <button class="modal-close" onclick="closeModal('artistModal')">&times;</button>
        </div>
        <div class="modal-body" id="artistModalContent"></div>
    </div>
</div>

<!-- Agent Output Modal -->
<div class="modal-overlay" id="agentModal">
    <div class="modal">
        <div class="modal-header">
            <h3>ü§ñ AI Agent Results</h3>
            <button class="modal-close" onclick="closeModal('agentModal')">&times;</button>
        </div>
        <div class="modal-body" id="agentModalContent"></div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
    // Password protection
    (function() {
        var storedAuth = sessionStorage.getItem('108admin');
        if (storedAuth !== 'authenticated') {
            var password = prompt('Enter admin password:');
            if (password !== 'Sutra108!') {
                document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;"><h1 style="color:#ef4444;">Access Denied</h1></div>';
                throw new Error('Unauthorized');
            }
            sessionStorage.setItem('108admin', 'authenticated');
        }
    })();

    const API = 'https://onezeroeight-backend-production.up.railway.app/api';
    
    // Playlist configuration
    const PLAYLISTS = {
        discoveries: { id: "2DjGILNUx6ZKj6UFANaWrH", name: "OneZeroEight: Discoveries", emoji: "üéµ" },
        electronic: { id: "1QDLk6PVWoNZgqOU4eVowV", name: "OneZeroEight: Electronic", emoji: "‚ö°" },
        lofi: { id: "4UxQQTkDM1lMPzcR2ofpNB", name: "OneZeroEight: Lo-Fi & Chill", emoji: "‚òï" },
        hiphop: { id: "7awVYiLk5EA3b6XgraQpem", name: "OneZeroEight: Hip Hop", emoji: "üé§" },
        pop: { id: "1WLd37m8nWFIq7y6yZetto", name: "OneZeroEight: Pop", emoji: "‚ú®" },
        rnb: { id: "28CI6nHmaBDMZ1grSYoL4y", name: "OneZeroEight: R&B & Soul", emoji: "üíú" },
        ambient: { id: "5DqBzx9ou98BcehqkF2dXs", name: "OneZeroEight: Ambient", emoji: "üåô" },
        rock: { id: "60Hp0raJkuDyjvr2M6iwnk", name: "OneZeroEight: Rock & Alternative", emoji: "üé∏" },
        indie: { id: "6IVrZl1UiMba2V1A01zntL", name: "OneZeroEight: Indie & Folk", emoji: "üçÇ" },
        jazz: { id: "3NzKhKUj8sUaDm3p85gMMv", name: "OneZeroEight: Jazz & Blues", emoji: "üé∑" },
        classical: { id: "2vvYwga5AY35LXCpUf1mEm", name: "OneZeroEight: Classical & Cinematic", emoji: "üéª" },
        latin: { id: "2FouNlNr5Z86JkGqH1Z9lq", name: "OneZeroEight: Latin", emoji: "üî•" },
        world: { id: "0P4mQy5bjTz5QUXnh9XAxC", name: "OneZeroEight: World & Global", emoji: "üåç" },
        country: { id: "5H31gmiH3MD9nflKmQtkS1", name: "OneZeroEight: Country", emoji: "ü§†" },
        gospel: { id: "0qs0ALpOZEQyPZl54ZketH", name: "OneZeroEight: Gospel & Christian", emoji: "üôè" }
    };

    const GENRE_MAP = {
        'electronic': 'electronic', 'edm': 'electronic', 'house': 'electronic', 'techno': 'electronic',
        'trance': 'electronic', 'synthwave': 'electronic', 'dubstep': 'electronic',
        'lo-fi': 'lofi', 'lofi': 'lofi', 'chillhop': 'lofi', 'chill': 'lofi', 'downtempo': 'lofi',
        'hip hop': 'hiphop', 'hip-hop': 'hiphop', 'rap': 'hiphop', 'trap': 'hiphop', 'drill': 'hiphop',
        'pop': 'pop', 'indie pop': 'pop', 'synth pop': 'pop', 'electropop': 'pop',
        'r&b': 'rnb', 'rnb': 'rnb', 'soul': 'rnb', 'neo-soul': 'rnb', 'funk': 'rnb',
        'ambient': 'ambient', 'atmospheric': 'ambient', 'meditation': 'ambient',
        'rock': 'rock', 'alternative': 'rock', 'indie rock': 'rock', 'metal': 'rock', 'punk': 'rock',
        'indie': 'indie', 'folk': 'indie', 'acoustic': 'indie', 'singer-songwriter': 'indie',
        'jazz': 'jazz', 'blues': 'jazz', 'smooth jazz': 'jazz',
        'classical': 'classical', 'orchestral': 'classical', 'cinematic': 'classical',
        'latin': 'latin', 'reggaeton': 'latin', 'salsa': 'latin', 'bachata': 'latin',
        'world': 'world', 'afrobeats': 'world', 'reggae': 'world',
        'country': 'country', 'americana': 'country', 'bluegrass': 'country',
        'gospel': 'gospel', 'christian': 'gospel', 'worship': 'gospel'
    };

    function getPlaylistForGenre(genre) {
        if (!genre) return PLAYLISTS.discoveries;
        const key = GENRE_MAP[genre.toLowerCase()] || 'discoveries';
        return PLAYLISTS[key] || PLAYLISTS.discoveries;
    }

    function getPlaylistKey(genre) {
        if (!genre) return 'discoveries';
        return GENRE_MAP[genre.toLowerCase()] || 'discoveries';
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast ' + type + ' show';
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function showPanel(panelName) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('panel-' + panelName).classList.add('active');
        event.target.classList.add('active');
        
        if (panelName === 'submissions') loadSubmissions();
        if (panelName === 'artists') loadArtists();
        if (panelName === 'curators') loadCurators();
        if (panelName === 'playlists') loadPlaylists();
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
    }

    // Load stats
    async function loadStats() {
        try {
            // Get artist count directly from artists list for accuracy
            const artistRes = await fetch(API + '/admin/artists?page_size=1000');
            const artistData = await artistRes.json();
            const artistCount = (artistData.artists || []).length;
            document.getElementById('statArtists').textContent = artistCount;
            
            // Get other stats
            const res = await fetch(API + '/admin/stats');
            const data = await res.json();
            document.getElementById('statCurators').textContent = data.total_curators || 0;
            document.getElementById('statPlacements').textContent = data.total_placements || 0;
            
            // Get submission count from campaigns
            const campRes = await fetch(API + '/admin/campaigns?page_size=100');
            const campData = await campRes.json();
            document.getElementById('statSubmissions').textContent = (campData.campaigns || []).length;
        } catch (err) {
            console.error('Failed to load stats:', err);
        }
    }

    // Load submissions
    async function loadSubmissions() {
        const tbody = document.getElementById('submissionsTable');
        tbody.innerHTML = '<tr><td colspan="7" class="loading">Loading...</td></tr>';
        
        try {
            const res = await fetch(API + '/admin/campaigns?page_size=50');
            const data = await res.json();
            const campaigns = data.campaigns || [];
            
            if (campaigns.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No submissions yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = campaigns.map(c => {
                const genre = c.genre || c.track_genre || 'Unknown';
                const playlistKey = getPlaylistKey(genre);
                const playlist = PLAYLISTS[playlistKey] || PLAYLISTS.discoveries;
                const status = c.status || 'draft';
                const tier = c.tier || 'free';
                
                return `
                    <tr>
                        <td>
                            <strong>${c.track_title || 'Untitled'}</strong>
                            ${c.spotify_link ? `<br><a href="${c.spotify_link}" target="_blank" style="font-size:0.75rem;color:var(--primary);">Spotify</a>` : ''}
                        </td>
                        <td>${c.artist_name || '-'}</td>
                        <td><span class="badge badge-info">${genre}</span></td>
                        <td><span class="playlist-badge playlist-${playlistKey}">${playlist.emoji} ${playlist.name.replace('OneZeroEight: ', '')}</span></td>
                        <td><span class="badge ${tier === 'pro' ? 'badge-primary' : 'badge-warning'}">${tier}</span></td>
                        <td><span class="badge ${status === 'placed' ? 'badge-success' : 'badge-warning'}">${status}</span></td>
                        <td class="actions">
                            <button class="action-btn agent" onclick="runAgents('${c.track_title}', '${c.artist_name}', '${c.spotify_link || ''}', '${genre}')" title="Run AI Agents">ü§ñ</button>
                            <button class="action-btn ${status === 'placed' ? 'placed' : ''}" onclick="markPlaced('${c.id}')" title="Mark as Placed">${status === 'placed' ? '‚úì' : 'üìã'}</button>
                            <button class="action-btn" onclick="sendEmail('${c.id}')" title="Placement Email">üìß</button>
                            <button class="action-btn" onclick="sendUpdateEmail('${c.id}')" title="Send AI Update Email" style="border-color:#8b5cf6;color:#8b5cf6;">üìä</button>
                            <button class="action-btn delete" onclick="deleteCampaign('${c.id}')" title="Delete">üóë</button>
                        </td>
                    </tr>
                `;
            }).join('');
        } catch (err) {
            console.error('Failed to load submissions:', err);
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Failed to load</td></tr>';
        }
    }

    // Load artists
    async function loadArtists() {
        const tbody = document.getElementById('artistsTable');
        tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading...</td></tr>';
        
        try {
            const res = await fetch(API + '/admin/artists?page_size=100');
            const data = await res.json();
            const artists = data.artists || [];
            
            if (artists.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No artists yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = artists.map(a => `
                <tr>
                    <td><strong>${a.name || '-'}</strong></td>
                    <td>${a.email || '-'}</td>
                    <td>${a.artist_name || '-'}</td>
                    <td>${a.genre ? `<span class="badge badge-info">${a.genre}</span>` : '-'}</td>
                    <td>${a.created_at ? new Date(a.created_at).toLocaleDateString() : '-'}</td>
                    <td class="actions">
                        <button class="action-btn" onclick="editArtist('${a.id}', '${(a.name || '').replace(/'/g, "\\'")}', '${a.email}', '${(a.artist_name || '').replace(/'/g, "\\'")}', '${a.genre || ''}', '${a.spotify_link || ''}')">‚úèÔ∏è Edit</button>
                        <button class="action-btn" onclick="createCampaign('${a.email}', '${(a.artist_name || '').replace(/'/g, "\\'")}', '${a.spotify_link || ''}', '${a.genre || ''}')">‚ûï Campaign</button>
                    </td>
                </tr>
            `).join('');
        } catch (err) {
            console.error('Failed to load artists:', err);
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Failed to load</td></tr>';
        }
    }

    // Load curators
    async function loadCurators() {
        const tbody = document.getElementById('curatorsTable');
        tbody.innerHTML = '<tr><td colspan="4" class="loading">Loading...</td></tr>';
        
        try {
            const res = await fetch(API + '/admin/curators?page_size=50');
            const data = await res.json();
            const curators = data.curators || [];
            
            document.getElementById('curatorCount').textContent = `(${data.total || curators.length} total)`;
            
            tbody.innerHTML = curators.slice(0, 50).map(c => `
                <tr>
                    <td><strong>${c.name || '-'}</strong></td>
                    <td>${c.email || '-'}</td>
                    <td>${(c.total_followers || 0).toLocaleString()}</td>
                    <td><span class="badge ${c.status === 'active' ? 'badge-success' : 'badge-warning'}">${c.status || 'new'}</span></td>
                </tr>
            `).join('');
        } catch (err) {
            console.error('Failed to load curators:', err);
            tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Failed to load</td></tr>';
        }
    }

    // Load playlists
    function loadPlaylists() {
        const tbody = document.getElementById('playlistsTable');
        tbody.innerHTML = Object.entries(PLAYLISTS).map(([key, p]) => {
            const genres = Object.entries(GENRE_MAP).filter(([g, k]) => k === key).map(([g]) => g).slice(0, 4);
            return `
                <tr>
                    <td><span class="playlist-badge playlist-${key}">${p.emoji} ${p.name}</span></td>
                    <td>${genres.map(g => `<span class="badge badge-info" style="margin:2px;">${g}</span>`).join(' ')}</td>
                    <td style="font-family:monospace;font-size:0.8rem;">${p.id}</td>
                    <td><a href="https://open.spotify.com/playlist/${p.id}" target="_blank" class="action-btn">Open</a></td>
                </tr>
            `;
        }).join('');
    }

    // Edit artist
    function editArtist(id, name, email, artistName, genre, spotifyLink) {
        const content = document.getElementById('artistModalContent');
        content.innerHTML = `
            <form onsubmit="saveArtist(event, '${id}')">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="editName" value="${name}" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editEmail" value="${email}" required>
                </div>
                <div class="form-group">
                    <label>Artist Name</label>
                    <input type="text" id="editArtistName" value="${artistName}">
                </div>
                <div class="form-group">
                    <label>Genre</label>
                    <select id="editGenre">
                        <option value="">Select...</option>
                        ${Object.keys(GENRE_MAP).filter((v, i, a) => a.indexOf(v) === i).slice(0, 20).map(g => 
                            `<option value="${g}" ${g === genre ? 'selected' : ''}>${g}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label>Spotify Link</label>
                    <input type="url" id="editSpotify" value="${spotifyLink}">
                </div>
                <div style="display:flex;gap:12px;margin-top:20px;">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button type="button" class="btn btn-danger" onclick="deleteArtist('${id}')">Delete Artist</button>
                </div>
            </form>
        `;
        document.getElementById('artistModal').classList.add('active');
    }

    async function saveArtist(event, id) {
        event.preventDefault();
        const data = {
            name: document.getElementById('editName').value,
            email: document.getElementById('editEmail').value,
            artist_name: document.getElementById('editArtistName').value,
            genre: document.getElementById('editGenre').value,
            spotify_link: document.getElementById('editSpotify').value
        };
        
        try {
            const res = await fetch(API + '/admin/artists/' + id, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                showToast('Artist updated!');
                closeModal('artistModal');
                loadArtists();
            } else {
                showToast('Failed to update', 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    async function deleteArtist(id) {
        if (!confirm('Delete this artist?')) return;
        try {
            const res = await fetch(API + '/admin/artists/' + id, { method: 'DELETE' });
            if (res.ok) {
                showToast('Artist deleted');
                closeModal('artistModal');
                loadArtists();
                loadStats();
            } else {
                showToast('Failed to delete', 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    // Create campaign from artist
    async function createCampaign(email, artistName, spotifyLink, genre) {
        // Confirm before creating
        if (!confirm(`Create campaign for ${artistName}?\n\nSpotify: ${spotifyLink || 'None'}\nGenre: ${genre || 'Not set'}`)) {
            return;
        }
        
        // Use artist name as track placeholder - AI agents will analyze the actual track
        let trackTitle = artistName + ' - Submitted Track';
        
        const data = {
            track_title: trackTitle,
            spotify_link: spotifyLink || 'https://spotify.com',
            genre: genre || 'indie',
            tier: 'free',
            payment_method: 'usd'
        };
        
        try {
            const res = await fetch(API + '/campaigns/create?artist_email=' + encodeURIComponent(email), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();
            
            if (result.id) {
                showToast('Campaign created for ' + artistName + '!');
                loadSubmissions();
                loadStats();
            } else {
                showToast('Failed: ' + (result.detail || 'Unknown error'), 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    // Run AI agents
    async function runAgents(trackTitle, artistName, spotifyUrl, genre) {
        const content = document.getElementById('agentModalContent');
        content.innerHTML = '<p>Running AI agents... this may take 30-60 seconds.</p><div class="agent-output">Initializing...</div>';
        document.getElementById('agentModal').classList.add('active');
        
        const output = content.querySelector('.agent-output');
        
        try {
            // Analysis
            output.textContent = 'üîç Running track analysis...';
            const analysisRes = await fetch(`${API}/workflow/agent/analyze-track?track_title=${encodeURIComponent(trackTitle)}&artist_name=${encodeURIComponent(artistName)}&spotify_url=${encodeURIComponent(spotifyUrl)}`, { method: 'POST' });
            const analysis = await analysisRes.json();
            
            output.textContent += '\n‚úÖ Analysis complete!\n\n';
            output.textContent += 'Genre Tags: ' + (analysis.analysis?.genre_tags?.join(', ') || 'N/A') + '\n';
            output.textContent += 'Mood: ' + (analysis.analysis?.mood?.join(', ') || 'N/A') + '\n';
            output.textContent += 'Energy: ' + (analysis.analysis?.energy_level || 'N/A') + '/10\n';
            output.textContent += 'Target Audience: ' + (analysis.analysis?.target_audience || 'N/A') + '\n';
            output.textContent += '\nPlaylist Pitch:\n' + (analysis.analysis?.playlist_pitch || 'N/A') + '\n';
            
            // Social posts
            output.textContent += '\n\nüê¶ Generating social posts...';
            const socialRes = await fetch(`${API}/workflow/agent/generate-social?track_title=${encodeURIComponent(trackTitle)}&artist_name=${encodeURIComponent(artistName)}&spotify_url=${encodeURIComponent(spotifyUrl)}&genre=${encodeURIComponent(genre)}`, { method: 'POST' });
            const social = await socialRes.json();
            
            output.textContent += '\n‚úÖ Social posts generated!\n\n';
            output.textContent += '--- Twitter ---\n' + (social.posts?.twitter || 'N/A') + '\n\n';
            output.textContent += '--- Instagram ---\n' + (social.posts?.instagram || 'N/A') + '\n\n';
            output.textContent += '--- Discord ---\n' + (social.posts?.discord || 'N/A');
            
            showToast('AI agents completed!');
        } catch (err) {
            output.textContent += '\n\n‚ùå Error: ' + err.message;
            showToast('Agent error', 'error');
        }
    }

    // Mark placed
    async function markPlaced(id) {
        try {
            await fetch(API + '/admin/campaigns/' + id + '/status', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'placed' })
            });
            showToast('Marked as placed + Discord notified!');
            loadSubmissions();
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    // Send placement email
    async function sendEmail(id) {
        try {
            const res = await fetch(API + '/admin/campaigns/' + id + '/notify-placement', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                showToast('Placement email sent!');
            } else {
                showToast('Failed to send email', 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    // Send consolidated AI update email
    async function sendUpdateEmail(id) {
        showToast('Generating AI update email...', 'success');
        try {
            const res = await fetch(API + '/admin/campaigns/' + id + '/send-update', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                showToast('AI Update email sent! ' + data.subject);
            } else {
                showToast('Failed: ' + (data.detail || 'Unknown error'), 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    // Delete campaign
    async function deleteCampaign(id) {
        if (!confirm('Delete this submission?')) return;
        try {
            await fetch(API + '/admin/campaigns/' + id, { method: 'DELETE' });
            showToast('Deleted');
            loadSubmissions();
            loadStats();
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    // Click outside modal to close
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) this.classList.remove('active');
        });
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        loadSubmissions();
        loadPlaylists();
    });
</script>

</body>
</html>
